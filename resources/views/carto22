<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte du Sénégal</title>

  <!-- Flowbite -->
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.css" rel="stylesheet">

  <style>
    .map-container{ position:relative; display:inline-block; }
    .center-image{ display:block; margin-left:auto; margin-right:auto; max-width:100%; height:auto; }

    /* Tooltip (liste des établissements au survol) */
    .tooltip{
      position:absolute; z-index:1000;
      background:#0b1b28; color:#fff; padding:12px 14px;
      border-radius:10px; font-size:14px; line-height:1.35; pointer-events:none;
      max-width:min(320px, 70vw); box-shadow:0 12px 24px rgba(0,0,0,.25);
      display:none;
    }
    .tooltip h3{margin:0 0 6px; font-size:15px}
    .tooltip small{opacity:.8}
    .tooltip .list{max-height:220px; overflow:auto; margin-top:8px}
    .tooltip .list::-webkit-scrollbar{height:8px;width:8px}
    .tooltip .list::-webkit-scrollbar-thumb{background:#3b4a57;border-radius:8px}

    /* Pastilles de comptage */
    .region-badge{
      position:absolute; transform:translate(-50%,-50%);
      background:#e74c3c; color:#fff;
      min-width:28px; height:28px; padding:0 8px;
      border-radius:999px; display:flex; align-items:center; justify-content:center;
      font-size:13px; font-weight:800; white-space:nowrap;
      box-shadow:0 4px 12px rgba(231,76,60,.4);
      pointer-events:none; /* ne bloque pas le clic sur la zone <area> */
    }
    .region-badge[data-hot="1"]{ background:#15a362; box-shadow:0 4px 12px rgba(21,163,98,.35) }

    /* Modals */
    .modal{ display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000; }

    /* Tableau scrollable (modal des départements) */
    .scrollable-table{ max-height:400px; overflow-y:auto; border:1px solid #ccc; }
    .scrollable-table table{ width:100%; border-collapse:collapse; }
    .scrollable-table th, .scrollable-table td{ border:1px solid #ddd; padding:8px; text-align:left; }
    .scrollable-table th{ background-color:#f2f2f2; }
  </style>
</head>
<body class="p-4">

  <div class="map-container mx-auto">
    <!-- Image + conteneurs des pastilles/tooltip -->
    <img id="carteImage"
         src="{{ asset('carte.gif') }}"
         alt="Carte du Sénégal"
         usemap="#carte_senegal"
         class="center-image" />

    <div id="badges-container"></div>
    <div id="tooltip" class="tooltip"></div>

    <!-- Zones cliquables -->
    <map name="carte_senegal">
      @foreach($departements as $departement)
        <area
          target=""
          alt="{{ $departement->nom_depart }}"
          title="{{ $departement->nom_depart }}"
          href="#"
          coords="{{ $departement->coords }}"
          shape="poly"
          data-modal-toggle="dep-modal-{{ $departement->id }}">
        <!-- Modal Département -->
        <div id="dep-modal-{{ $departement->id }}"
             data-modal-backdrop="static"
             tabindex="-1" aria-hidden="true"
             class="hidden fixed inset-0 z-50 overflow-y-auto overflow-x-hidden flex items-center justify-center bg-black bg-opacity-50">
          <div class="relative p-4 w-full max-w-2xl mx-auto">
            <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
              <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white absolute left-1/2 transform -translate-x-1/2 -translate-y-1/2 top-5">
                  {{ $departement->nom_depart }}
                </h3>
              </div>

              <div class="px-3 py-2 scrollable-table">
                @if($departement->efpts->isEmpty())
                  <p class="text-center text-gray-500">Pas d’établissement</p>
                @else
                  <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                      <tr class="bg-gray-100">
                        <th class="px-4 py-2 border">Nom</th>
                        <th class="px-4 py-2 border">Téléphone</th>
                        <th class="px-4 py-2 border">Adresse</th>
                        <th class="px-4 py-2 border">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @foreach($departement->efpts as $etablissement)
                        <tr>
                          <td class="px-4 py-2 border">{{ $etablissement->nom }}</td>
                          <td class="px-4 py-2 border">{{ $etablissement->tel }}</td>
                          <td class="px-4 py-2 border">{{ $etablissement->adresse }}</td>
                          <td class="px-4 py-2 border">
                            <a href="#"
                               class="open-efp block text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                               data-open-efp="efp-modal-{{ $etablissement->id }}">
                              Voir formations
                            </a>
                          </td>
                        </tr>
                      @endforeach
                    </tbody>
                  </table>
                @endif
              </div>

              <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button data-modal-hide="dep-modal-{{ $departement->id }}"
                        type="button"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                  Fermer
                </button>
              </div>
            </div>
          </div>
        </div>
      @endforeach
    </map>

    <!-- Modals Établissements (formations) -->
    @foreach($departements as $departement)
      @foreach($departement->efpts as $etablissement)
        <div id="efp-modal-{{ $etablissement->id }}"
             data-modal-backdrop="static"
             tabindex="-1" aria-hidden="true"
             class="bg-black bg-opacity-25 hidden overflow-y-auto overflow-x-hidden fixed top-0 left-0 z-50 w-full h-full flex items-center justify-center">
          <div class="fixed inset-0 bg-black opacity-50"></div>
          <div class="relative p-4 w-full max-w-2xl max-h-full transform translate-x-10">
            <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
              <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                  {{ $etablissement->nom }}
                </h3>
              </div>

              <div class="px-3 py-2">
                <table class="w-full border border-gray-200">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="px-4 py-2 border bg-blue-700 text-white">Filières/Métiers</th>
                      <th class="px-4 py-2 border bg-blue-700 text-white">Niveau</th>
                    </tr>
                  </thead>
                  <tbody>
                    @foreach($etablissement->programms as $programm)
                      <tr>
                        <td class="px-4 py-2 border">{{ $programm->nom ?? '-' }}</td>
                        <td class="px-4 py-2 border">{{ $programm->grade->nom ?? '-' }}</td>
                      </tr>
                    @endforeach
                  </tbody>
                </table>
              </div>

              <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button data-modal-hide="efp-modal-{{ $etablissement->id }}"
                        type="button"
                        class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                  Fermer
                </button>
              </div>
            </div>
          </div>
        </div>
      @endforeach
    @endforeach
  </div>

  <!-- Flowbite JS -->
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.js"></script>

  <script>
    // ===== Données JS (listes d'établissements par département, depuis Blade) =====
    const establishments = {};
    @foreach($departements as $d)
      establishments[@json($d->nom_depart)] = @json($d->efpts->pluck('nom')->values());
    @endforeach

    // ===== Références DOM =====
    const mapImage = document.getElementById('carteImage');
    const badgesContainer = document.getElementById('badges-container');
    const tooltip = document.getElementById('tooltip');
    const areas = Array.from(document.querySelectorAll('map[name="carte_senegal"] area'));

    // ===== Placement des pastilles (compte) =====
    function getPolyCenter(area){
      const pts = area.coords.split(',').map(Number);
      let sx=0, sy=0, n=0;
      for(let i=0;i<pts.length;i+=2){ sx+=pts[i]; sy+=pts[i+1]; n++; }
      return { x: sx/n, y: sy/n };
    }

    function createCountBadges(){
      const w = mapImage.naturalWidth  || mapImage.clientWidth;
      const h = mapImage.naturalHeight || mapImage.clientHeight;
      badgesContainer.innerHTML = '';

      areas.forEach(area=>{
        const key = area.title || area.alt || '';
        const count = (establishments[key]?.length || 0);
        if(count>0){
          const {x,y} = getPolyCenter(area);
          const badge = document.createElement('div');
          badge.className = 'region-badge';
          const label = (count >= 100) ? '99+' : String(count);
          badge.textContent = label;

          // Position en % => reste correct au redimensionnement / zoom
          badge.style.left = (x / w * 100) + '%';
          badge.style.top  = (y / h * 100) + '%';

          if(count >= 10) badge.setAttribute('data-hot','1');
          badgesContainer.appendChild(badge);
        }
      });
    }

    // ===== Tooltip (survol) =====
    function positionTooltip(e){
      const pad = 16;
      const rect = mapImage.getBoundingClientRect();
      const tw = Math.min(320, window.innerWidth*0.7);
      const x = Math.min(e.pageX + pad, window.scrollX + rect.right - tw - pad);
      const y = Math.min(e.pageY + pad, window.scrollY + rect.bottom - 180);
      tooltip.style.left = x + 'px';
      tooltip.style.top  = y + 'px';
    }
    function showTooltip(regionName, e){
      const list = establishments[regionName] || [];
      if(list.length === 0) return;
      const title = `<h3>${regionName}</h3><small>${list.length} établissement(s)</small>`;
      const items = list.map(n => `• ${n}`).join('<br>');
      tooltip.innerHTML = `${title}<div class="list">${items}</div>`;
      tooltip.style.display = 'block';
      positionTooltip(e);
    }
    function hideTooltip(){ tooltip.style.display = 'none'; }

    // Survol (sans bloquer le clic Flowbite)
    areas.forEach(area=>{
      area.addEventListener('mouseover', e => showTooltip(area.title || area.alt, e));
      area.addEventListener('mousemove', positionTooltip);
      area.addEventListener('mouseout', hideTooltip);
    });

    // ===== Init =====
    function init(){
      if(!mapImage.complete){
        mapImage.addEventListener('load', createCountBadges, { once:true });
      }else{
        createCountBadges();
      }
      window.addEventListener('resize', createCountBadges);
    }
    document.addEventListener('DOMContentLoaded', init);

    // ===== Passage Département -> Établissement =====
    document.querySelectorAll('.open-efp').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const targetId = btn.getAttribute('data-open-efp');
        const efp = document.getElementById(targetId);

        // Fermer le modal département parent
        const depModal = btn.closest('[id^="dep-modal-"]');
        if (depModal) {
          depModal.classList.add('hidden');
          depModal.classList.remove('flex');
          document.body.style.overflow = '';
        }

        // Ouvrir le modal établissement
        if (efp) {
          efp.classList.remove('hidden');
          efp.classList.add('flex');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    // Fermeture des modals établissement (bouton data-modal-hide)
    document.querySelectorAll('[id^="efp-modal-"] [data-modal-hide]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-modal-hide');
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = '';
        }
      });
    });

    // Fermer en cliquant en dehors (fallback)
    document.querySelectorAll('[id^="dep-modal-"], [id^="efp-modal-"]').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = '';
        }
      });
    });
  </script>
</body>
</html>
